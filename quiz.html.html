<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YCHã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª æœ€çµ‚å®Œå…¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .center {
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        h2 {
            font-size: 2rem;
            color: white;
            margin-bottom: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .btn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            color: #667eea;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
            user-select: none;
        }
        
        .btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .choice-btn {
            display: block;
            width: 100%;
            max-width: 600px;
            margin: 15px auto;
            padding: 18px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            user-select: none;
        }
        
        .choice-btn:hover {
            background: #f0f7ff;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(5px);
        }
        
        #question-text {
            color: white;
            font-size: 1.3rem;
            background: rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            line-height: 1.6;
        }
        
        .progress {
            color: white;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            max-width: 200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .character-display {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .character-image {
            width: 100px;
            height: 100px;
            flex-shrink: 0;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .character-message {
            text-align: left;
            font-size: 1rem;
            color: #333;
            line-height: 1.6;
        }
        
        .feedback-box {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .feedback-result {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .correct {
            color: #10b981;
        }
        
        .incorrect {
            color: #ef4444;
        }
        
        .explanation {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .result-summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .result-character-image {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            border-radius: 15px;
            object-fit: cover;
        }
        
        .score-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }
        
        .accuracy {
            font-size: 1.2rem;
            color: #666;
            margin: 10px 0;
        }
        
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .badge-item {
            text-align: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .badge-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }
        
        .badge-name {
            font-size: 0.8rem;
            color: #666;
            word-break: break-word;
        }
        
        .button-group {
            text-align: center;
            margin-top: 2rem;
        }
        
        .secondary-btn {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            margin: 5px;
        }
        
        .confirm-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .confirm-item {
            font-size: 1rem;
            color: #333;
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .confirm-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .confirm-value {
            font-size: 1.1rem;
            color: #333;
            font-weight: bold;
        }
        
        .success-screen {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .success-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .character-select-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px auto;
            max-width: 700px;
        }
        
        .char-select-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .char-select-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .char-select-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 10px;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .char-select-name {
            font-weight: bold;
            color: #667eea;
            margin-top: 10px;
        }
        
        .stats-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            margin: 15px 0;
            font-size: 1rem;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        
        .no-data {
            color: #999;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen" class="screen active center">
        <h1>ğŸ® YCH<br>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</h1>
        <p style="color: white; font-size: 1.2rem; margin-bottom: 2rem; margin-top: 2rem;">åŒ»ç™‚å¾“äº‹è€…å‘ã‘å­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
        <button class="btn" id="btn-start-quiz" onclick="goToCharacterScreen()" style="font-size: 1.2rem; padding: 20px 40px;">ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹ âœ¨</button>
        <button class="btn secondary-btn" id="btn-view-stats" onclick="goToStatsScreen()" style="font-size: 1.2rem; padding: 20px 40px; margin-top: 1rem;">ğŸ“Š æˆç¸¾ã‚’è¦‹ã‚‹</button>
    </div>
    
    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ -->
    <div id="character-screen" class="screen center">
        <button class="btn secondary-btn" onclick="goToStartScreen()">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        <h2>ğŸ§‘â€âš•ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ</h2>
        <div class="character-select-grid">
            <div class="char-select-card" onclick="selectCharacter('PT')">
                <img class="char-select-image" src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/2beeab7a-d724-4b19-a8b8-148b61bc8d07.png" alt="PT">
                <div class="char-select-name">PT<br>ç†å­¦ç™‚æ³•å£«</div>
            </div>
            <div class="char-select-card" onclick="selectCharacter('OT')">
                <img class="char-select-image" src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/8382b224-fad3-4d0e-a9c4-11a09b5f4586.png" alt="OT">
                <div class="char-select-name">OT<br>ä½œæ¥­ç™‚æ³•å£«</div>
            </div>
            <div class="char-select-card" onclick="selectCharacter('ST')">
                <img class="char-select-image" src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/0aefa67f-a92d-4c08-9678-3ff89d0d0a90.png" alt="ST">
                <div class="char-select-name">ST<br>è¨€èªè´è¦šå£«</div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ¬ãƒ™ãƒ«é¸æŠç”»é¢ -->
    <div id="level-screen" class="screen center">
        <button class="btn secondary-btn" onclick="goToCharacterScreen()">â† ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«æˆ»ã‚‹</button>
        <h2>ğŸ“š ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</h2>
        <button class="btn" id="btn-level-1" onclick="selectLevel('åˆç´š')" style="width: 90%; max-width: 400px;">åˆç´šï¼ˆåŸºç¤çŸ¥è­˜ï¼‰</button>
        <button class="btn" id="btn-level-2" onclick="selectLevel('ä¸­ç´š')" style="width: 90%; max-width: 400px;">ä¸­ç´šï¼ˆå¿œç”¨æŠ€è¡“ï¼‰</button>
        <button class="btn" id="btn-level-3" onclick="selectLevel('ä¸Šç´š')" style="width: 90%; max-width: 400px;">ä¸Šç´šï¼ˆè‡¨åºŠåˆ¤æ–­ï¼‰</button>
    </div>
    
    <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
    <div id="quiz-screen" class="screen center">
        <div class="progress" id="progress">1/5</div>
        <h2 id="question-text"></h2>
        <div id="choices-container"></div>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”»é¢ -->
    <div id="feedback-screen" class="screen center">
        <div id="character-feedback" class="character-display"></div>
        <div class="feedback-box">
            <div class="feedback-result" id="feedback-result"></div>
            <div class="explanation" id="explanation"></div>
            <button class="btn" id="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
        </div>
    </div>
    
    <!-- çµæœç”»é¢ -->
    <div id="result-screen" class="screen center">
        <div class="result-summary">
            <h2>ğŸ‰ ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h2>
            <img id="result-char-image" class="result-character-image" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
            <div class="character-name" id="result-char-name"></div>
            <div class="score-display" id="score-display">5/5</div>
            <div class="accuracy" id="accuracy">æ­£ç­”ç‡: 100%</div>
            <div id="badge-display"></div>
            <div class="stat-item" style="text-align: center;">é›£æ˜“åº¦: <strong id="result-level"></strong></div>
        </div>
        <div class="button-group">
            <button class="btn btn-danger" id="btn-submit" onclick="moveToConfirm()">ğŸ“¤ çµæœã‚’é€ä¿¡</button>
            <button class="btn secondary-btn" id="btn-home-from-result" onclick="goToStartScreen()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>
    
    <!-- ç¢ºèªç”»é¢ -->
    <div id="confirm-screen" class="screen center">
        <div class="confirm-box">
            <h2>ğŸ“‹ çµæœã‚’ç¢ºèªã—ã¦é€ä¿¡</h2>
            <div class="confirm-item">
                <div class="confirm-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</div>
                <div class="confirm-value" id="confirm-character">-</div>
            </div>
            <div class="confirm-item">
                <div class="confirm-label">ãƒ¬ãƒ™ãƒ«</div>
                <div class="confirm-value" id="confirm-level">-</div>
            </div>
            <div class="confirm-item">
                <div class="confirm-label">æ­£è§£æ•°</div>
                <div class="confirm-value" id="confirm-score">-</div>
            </div>
            <div class="confirm-item">
                <div class="confirm-label">æ­£ç­”ç‡</div>
                <div class="confirm-value" id="confirm-accuracy">-</div>
            </div>
            <div class="confirm-item">
                <div class="confirm-label">ç²å¾—ãƒãƒƒã‚¸</div>
                <div class="confirm-value" id="confirm-badges">-</div>
            </div>
            <div class="button-group">
                <button class="btn btn-danger" id="btn-final-submit" onclick="finalSubmit()">âœ… ã“ã®å†…å®¹ã§é€ä¿¡</button>
                <button class="btn secondary-btn" id="btn-back-from-confirm" onclick="goToResultScreen()">â† æˆ»ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- æˆåŠŸç”»é¢ -->
    <div id="success-screen" class="screen center">
        <div class="success-screen">
            <div class="success-icon">âœ…</div>
            <h2>é€ä¿¡å®Œäº†ï¼</h2>
            <p style="font-size: 1rem; color: #666; margin: 20px 0;">
                ã‚¯ã‚¤ã‚ºçµæœãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«<br>æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚
            </p>
            <div style="margin: 20px 0; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                <p><strong id="success-character"></strong></p>
                <p><strong id="success-level"></strong></p>
                <p><strong id="success-score"></strong></p>
                <p><strong id="success-accuracy"></strong></p>
            </div>
            <button class="btn" id="btn-new-quiz" onclick="goToStartScreen()">æ–°ã—ã„ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹</button>
        </div>
    </div>
    
    <!-- æˆç¸¾ç”»é¢ -->
    <div id="stats-screen" class="screen center">
        <button class="btn secondary-btn" onclick="goToStartScreen()">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        <h2>ğŸ“Š æˆç¸¾ä¸€è¦§</h2>
        <div class="stats-display" id="stats-content"></div>
        <div id="chart-container" class="chart-container" style="display:none;">
            <canvas id="stats-chart"></canvas>
        </div>
    </div>
    
    <script>
        // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š ==========
        var gameState = {
            character: null,
            level: null,
            score: 0,
            currentQuestionIndex: 0,
            questions: [],
            answers: [],
            accuracy: 0,
            badges: [],
            scriptUrl: 'https://script.google.com/macros/s/AKfycbwfQ53VADYoNNLDFkgdhgwbMz9NY8-M12H6OBmRMwpQ9KpCTzsW6vs4F-XxxIqq25A-/exec'
        };
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±
        const characterInfo = {
            'PT': {
                name: 'ç†å­¦ç™‚æ³•å£«',
                image: 'https://user-gen-media-assets.s3.amazonaws.com/seedream_images/2beeab7a-d724-4b19-a8b8-148b61bc8d07.png',
                correct: 'ç´ æ™´ã‚‰ã—ã„ï¼é‹å‹•ç™‚æ³•ã®çŸ¥è­˜ãŒå®šç€ã—ã¦ã„ã¾ã™ã­ï¼',
                incorrect: 'æ¬¡å›ã¯å¤§ä¸ˆå¤«ã§ã™ã€‚ä¸€ç·’ã«å­¦ã³ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ï¼'
            },
            'OT': {
                name: 'ä½œæ¥­ç™‚æ³•å£«',
                image: 'https://user-gen-media-assets.s3.amazonaws.com/seedream_images/8382b224-fad3-4d0e-a9c4-11a09b5f4586.png',
                correct: 'å®Œç’§ã§ã™ï¼æ—¥å¸¸ç”Ÿæ´»å‹•ä½œã®ç†è§£ãŒé€²ã¿ã¾ã—ãŸã­ï¼',
                incorrect: 'ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸãªã‚‰ã§ãã¾ã™ï¼'
            },
            'ST': {
                name: 'è¨€èªè´è¦šå£«',
                image: 'https://user-gen-media-assets.s3.amazonaws.com/seedream_images/0aefa67f-a92d-4c08-9678-3ff89d0d0a90.png',
                correct: 'è‰¯ã„å›ç­”ã§ã™ï¼è¨€èªè´è¦šã®çŸ¥è­˜ãŒå¢—ãˆã¦ã„ã¾ã™ï¼',
                incorrect: 'å¤§ä¸ˆå¤«ã§ã™ã€‚å­¦ç¿’ã¯ç¹°ã‚Šè¿”ã—ãŒå¤§äº‹ã§ã™ã‚ˆï¼'
            }
        };
        
        // ãƒãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿
        const badges = [
            { name: 'ã¯ã˜ã‚ã®ä¸€æ­©', icon: 'ğŸ¯', condition: function() { return true; } },
            { name: 'å®Œç’§ä¸»ç¾©è€…', icon: 'ğŸ–ï¸', condition: function() { return gameState.accuracy === 100; } },
            { name: 'ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒã‚¹ã‚¿ãƒ¼', icon: 'âš¡', condition: function() { return gameState.accuracy >= 80; } },
            { name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ‡ãƒ¼ãƒ¢ãƒ³', icon: 'ğŸ¥‡', condition: function() { return gameState.accuracy >= 90; } },
            { name: 'åˆç´šãƒã‚¹ã‚¿ãƒ¼', icon: 'ğŸ†', condition: function() { return gameState.level === 'åˆç´š' && gameState.accuracy >= 80; } },
            { name: 'ä¸­ç´šãƒã‚¹ã‚¿ãƒ¼', icon: 'ğŸ“', condition: function() { return gameState.level === 'ä¸­ç´š' && gameState.accuracy >= 80; } },
            { name: 'PTå°‚é–€å®¶', icon: 'ğŸ‘¨â€âš•ï¸', condition: function() { return gameState.character === 'PT' && gameState.accuracy >= 75; } },
            { name: 'OTå°‚é–€å®¶', icon: 'ğŸ¬', condition: function() { return gameState.character === 'OT' && gameState.accuracy >= 75; } }
        ];
        
        // å•é¡Œãƒ‡ãƒ¼ã‚¿
        const allQuestions = {
            åˆç´š: [
                {q: "ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã«å«ã¾ã‚Œãªã„ã®ã¯ï¼Ÿ", c: ["ä½“æ¸©","å‘¼å¸æ•°","è¡€ç³–å€¤","è„ˆæ‹"], a: 2, e: "ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã¯ä½“æ¸©ãƒ»å‘¼å¸æ•°ãƒ»è„ˆæ‹ãƒ»è¡€åœ§ã‚’æŒ‡ã—ã¾ã™ã€‚è¡€ç³–å€¤ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚"},
                {q: "ç†å­¦ç™‚æ³•å£«ã®ä¸»ãªæ¥­å‹™ã¯ï¼Ÿ", c: ["é‹å‹•ç™‚æ³•","èª¿å‰¤","æ‰‹è¡“","è¨ºæ–­"], a: 0, e: "é‹å‹•ç™‚æ³•ã¨ç‰©ç†ç™‚æ³•ãŒç†å­¦ç™‚æ³•å£«ã®ä¸»ãªæ¥­å‹™ã§ã™ã€‚"},
                {q: "ä½œæ¥­ç™‚æ³•å£«ãŒæ‰±ã†é ˜åŸŸã¯ï¼Ÿ", c: ["è–¬ç‰©ç™‚æ³•","ADLè¨“ç·´","æ”¾å°„ç·š","æ „é¤Šç®¡ç†"], a: 1, e: "æ—¥å¸¸ç”Ÿæ´»å‹•ä½œï¼ˆADLï¼‰ã®è¨“ç·´ã¨æ”¹å–„ãŒä½œæ¥­ç™‚æ³•å£«ã®å°‚é–€ã§ã™ã€‚"},
                {q: "è¨€èªè´è¦šå£«ã®å¯¾è±¡éšœå®³ã¯ï¼Ÿ", c: ["æ•´å½¢å¤–ç§‘","è¨€èªè´è¦šéšœå®³","å†…è‡“ç–¾æ‚£","ç²¾ç¥ç–¾æ‚£"], a: 1, e: "è¨€èªè´è¦šéšœå®³ã®è©•ä¾¡ã¨æ²»ç™‚ãŒè¨€èªè´è¦šå£«ã®ä¸»ãªå½¹å‰²ã§ã™ã€‚"},
                {q: "QOLã¯ä½•ã®ç•¥ç§°ã‹ï¼Ÿ", c: ["Quality of Learning","Quantity of Life","Quality of Life","Quick Operation Level"], a: 2, e: "QOLã¯ç”Ÿæ´»ã®è³ªï¼ˆQuality of Lifeï¼‰ã‚’æ„å‘³ã—ã¾ã™ã€‚"}
            ],
            ä¸­ç´š: [
                {q: "ãƒˆãƒ¬ãƒ³ãƒ‡ãƒ¬ãƒ³ãƒ–ãƒ«ã‚°æ­©è¡Œã®åŸå› ã¯ï¼Ÿ", c: ["å¤§è…¿å››é ­ç­‹ä½ä¸‹","ä¸­æ®¿ç­‹ä½ä¸‹","ä¸‹è…¿ä¸‰é ­ç­‹ä½ä¸‹","è…¸è…°ç­‹ä½ä¸‹"], a: 1, e: "ä¸­æ®¿ç­‹ã®å¼±åŠ›ã«ã‚ˆã‚Šéª¨ç›¤ã®æ”¯æŒãŒå›°é›£ã¨ãªã‚Šã€ãƒˆãƒ¬ãƒ³ãƒ‡ãƒ¬ãƒ³ãƒ–ãƒ«ã‚°æ­©è¡ŒãŒç”Ÿã˜ã¾ã™ã€‚"},
                {q: "æ„Ÿè¦šçµ±åˆç™‚æ³•ã®å¯¾è±¡ã¯ï¼Ÿ", c: ["é«˜é½¢è€…","ç™ºé”éšœå®³å…","è„³å’ä¸­","æ•´å½¢å¤–ç§‘"], a: 1, e: "ç™ºé”éšœå®³å…ã®æ„Ÿè¦šå‡¦ç†èƒ½åŠ›ã®å‘ä¸ŠãŒæ„Ÿè¦šçµ±åˆç™‚æ³•ã®ç›®çš„ã§ã™ã€‚"},
                {q: "ãƒ•ã‚¡ãƒ³ãƒˆãƒ æ„Ÿè¦šã¸ã®å¯¾å‡¦ã¯ï¼Ÿ", c: ["æ”¾ç½®","å¤šæ„Ÿè¦šå…¥åŠ›ã¨å¿ƒç†çš„ã‚µãƒãƒ¼ãƒˆ","æ‰‹è¡“ã®ã¿","é®ç—›è–¬ã®ã¿"], a: 1, e: "å¿ƒç†çš„ãƒ»ç”Ÿç†çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®çµ„ã¿åˆã‚ã›ãŒæœ‰åŠ¹ã§ã™ã€‚"},
                {q: "æ‹˜ç¸®äºˆé˜²ã®é‹å‹•ç¯„å›²ã¯ï¼Ÿ", c: ["æœ€å°é™","å®Œå…¨å¯å‹•åŸŸå†…","å¼·åˆ¶çš„","è©•ä¾¡å¾Œã«æ±ºå®š"], a: 1, e: "é–¢ç¯€ã®å®Œå…¨å¯å‹•åŸŸå†…ã§ã®é‹å‹•ãŒæ‹˜ç¸®äºˆé˜²ã«æœ€ã‚‚æœ‰åŠ¹ã§ã™ã€‚"},
                {q: "é‹å‹•ç™‚æ³•ã®ç‰¹ç•°æ€§ã®åŸå‰‡ã¯ï¼Ÿ", c: ["ç¶™ç¶šã®ã¿","ç›®æ¨™å‹•ä½œã«ç‰¹ç•°çš„ãªè¨“ç·´","æ®µéšçš„è² è·","å€‹äººå·®ã®ã¿"], a: 1, e: "ç›®æ¨™ã¨ã™ã‚‹å‹•ä½œã«ç‰¹ç•°çš„ãªè¨“ç·´ãŒæœ€ã‚‚åŠ¹æœçš„ã§ã™ã€‚"}
            ],
            ä¸Šç´š: [
                {q: "BPSDã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§é©åˆ‡ãªã®ã¯ï¼Ÿ", c: ["è–¬ç‰©ç™‚æ³•ã®ã¿","ç’°å¢ƒèª¿æ•´ã¨å€‹åˆ¥å¯¾å¿œ","èº«ä½“æ‹˜æŸ","éš”é›¢"], a: 1, e: "BPSDã«ã¯ç’°å¢ƒå› å­ã®èª¿æ•´ã¨å€‹åˆ¥çš„ã‚±ã‚¢ãŒé‡è¦ã§ã™ã€‚"},
                {q: "ãƒ‹ãƒ¥ãƒ¼ãƒ­ã‚¸ã‚§ãƒ‹ãƒƒã‚¯ã‚·ãƒ§ãƒƒã‚¯ã®ç‰¹å¾´ã¯ï¼Ÿ", c: ["é »è„ˆã¨é«˜è¡€åœ§","å¾è„ˆã¨ä½è¡€åœ§","é »è„ˆã¨ä½è¡€åœ§","å¾è„ˆã¨é«˜è¡€åœ§"], a: 1, e: "äº¤æ„Ÿç¥çµŒæ©Ÿèƒ½ä½ä¸‹ã«ã‚ˆã‚Šå¾è„ˆã¨ä½è¡€åœ§ã‚’å‘ˆã—ã¾ã™ã€‚"},
                {q: "å‰é ­è‘‰ç—‡çŠ¶ã§ç‰¹å¾´çš„ãªã®ã¯ï¼Ÿ", c: ["è¨˜æ†¶éšœå®³","è¨€èªéšœå®³","é‚è¡Œæ©Ÿèƒ½éšœå®³","è¦–è¦šéšœå®³"], a: 2, e: "è¨ˆç”»ç«‹æ¡ˆãƒ»å®Ÿè¡Œãªã©ã®é‚è¡Œæ©Ÿèƒ½éšœå®³ãŒç‰¹å¾´çš„ã§ã™ã€‚"},
                {q: "é‡ç—‡ç­‹ç„¡åŠ›ç—‡æ‚£è€…ã¸ã®é…æ…®ã¯ï¼Ÿ", c: ["éåº¦è² è·","æ˜“ç–²åŠ´æ€§ã¸ã®é…æ…®","å¼·åŒ–è¨“ç·´","ç¶™ç¶šçš„è² è·"], a: 1, e: "æ˜“ç–²åŠ´æ€§ãŒç‰¹å¾´çš„ã§éåº¦è² è·ã¯ç—‡çŠ¶æ‚ªåŒ–ã‚’æ‹›ãã¾ã™ã€‚"},
                {q: "ICFã®æ„ç¾©ã¯ä½•ã‹ï¼Ÿ", c: ["åŒ»å­¦ãƒ¢ãƒ‡ãƒ«ã®ã¿","ç”Ÿç‰©å¿ƒç†ç¤¾ä¼šçš„ãƒ¢ãƒ‡ãƒ«","æ©Ÿèƒ½è©•ä¾¡ã®ã¿","éšœå®³åˆ†é¡ã®ã¿"], a: 1, e: "ICFã¯äººã®æ©Ÿèƒ½ã¨éšœå®³ã‚’åŒ…æ‹¬çš„ã«è©•ä¾¡ã™ã‚‹æ çµ„ã¿ã§ã™ã€‚"}
            ]
        };
        
        // ========== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•° ==========
        function showScreen(screenId) {
            try {
                if (!screenId || typeof screenId !== 'string') {
                    console.error('Invalid screen ID:', screenId);
                    return;
                }
                document.querySelectorAll('.screen').forEach(function(s) {
                    s.classList.remove('active');
                });
                var screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('active');
                } else {
                    console.error('Screen not found:', screenId);
                }
            } catch (error) {
                console.error('Error in showScreen:', error);
            }
        }
        
        function goToStartScreen() { showScreen('start-screen'); }
        function goToCharacterScreen() { showScreen('character-screen'); }
        function goToLevelScreen() { showScreen('level-screen'); }
        function goToResultScreen() { showScreen('result-screen'); }
        function goToStatsScreen() { 
            showScreen('stats-screen');
            loadStats();
        }
        
        // ========== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ¬ãƒ™ãƒ«é¸æŠ ==========
        function selectCharacter(char) {
            try {
                if (!char || !characterInfo[char]) {
                    console.error('Invalid character:', char);
                    return;
                }
                gameState.character = char;
                goToLevelScreen();
            } catch (error) {
                console.error('Error in selectCharacter:', error);
            }
        }
        
        function selectLevel(level) {
            try {
                if (!level || !allQuestions[level]) {
                    console.error('Invalid level:', level);
                    return;
                }
                gameState.level = level;
                gameState.score = 0;
                gameState.currentQuestionIndex = 0;
                gameState.answers = [];
                gameState.badges = [];
                
                var levelQuestions = allQuestions[level];
                var shuffled = shuffleArray(levelQuestions).slice(0, 5);
                gameState.questions = shuffled;
                
                startQuiz();
            } catch (error) {
                console.error('Error in selectLevel:', error);
            }
        }
        
        // ========== ã‚¯ã‚¤ã‚ºå®Ÿè¡Œ ==========
        function startQuiz() {
            try {
                showScreen('quiz-screen');
                showQuestion();
            } catch (error) {
                console.error('Error in startQuiz:', error);
            }
        }
        
        function showQuestion() {
            try {
                if (gameState.currentQuestionIndex >= gameState.questions.length) {
                    calculateBadges();
                    showResultScreen();
                    return;
                }
                
                var q = gameState.questions[gameState.currentQuestionIndex];
                if (!q) {
                    console.error('Question not found at index:', gameState.currentQuestionIndex);
                    return;
                }
                
                document.getElementById('progress').textContent = (gameState.currentQuestionIndex + 1) + '/5';
                document.getElementById('question-text').textContent = q.q;
                
                var container = document.getElementById('choices-container');
                if (!container) {
                    console.error('Choices container not found');
                    return;
                }
                container.innerHTML = '';
                
                q.c.forEach(function(choice, i) {
                    var btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = choice;
                    btn.onclick = function() {
                        selectAnswer(i, q.a, q.e);
                    };
                    container.appendChild(btn);
                });
            } catch (error) {
                console.error('Error in showQuestion:', error);
            }
        }
        
        function selectAnswer(selectedIndex, correctIndex, explanation) {
            try {
                var isCorrect = selectedIndex === correctIndex;
                var q = gameState.questions[gameState.currentQuestionIndex];
                
                gameState.answers.push({
                    question: q.q,
                    selected: q.c[selectedIndex],
                    correct: q.c[correctIndex],
                    isCorrect: isCorrect
                });
                
                if (isCorrect) {
                    gameState.score++;
                }
                
                var resultText = isCorrect ? 'âœ“ æ­£è§£ï¼' : 'âœ— ä¸æ­£è§£';
                var resultClass = isCorrect ? 'correct' : 'incorrect';
                
                var resultElement = document.getElementById('feedback-result');
                if (resultElement) {
                    resultElement.textContent = resultText;
                    resultElement.className = 'feedback-result ' + resultClass;
                }
                
                var explanationElement = document.getElementById('explanation');
                if (explanationElement) {
                    explanationElement.textContent = explanation;
                }
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                var charInfo = characterInfo[gameState.character];
                if (charInfo) {
                    var msg = isCorrect ? charInfo.correct : charInfo.incorrect;
                    var feedbackHtml = '<img class="character-image" src="' + charInfo.image + '" alt="' + charInfo.name + '">' +
                                     '<div class="character-message">' + msg + '</div>';
                    var feedbackElement = document.getElementById('character-feedback');
                    if (feedbackElement) {
                        feedbackElement.innerHTML = feedbackHtml;
                    }
                }
                
                var nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    if (gameState.currentQuestionIndex >= gameState.questions.length - 1) {
                        nextBtn.textContent = 'çµæœã‚’è¦‹ã‚‹';
                        nextBtn.onclick = function() {
                            gameState.currentQuestionIndex++;
                            calculateBadges();
                            showResultScreen();
                        };
                    } else {
                        nextBtn.textContent = 'æ¬¡ã®å•é¡Œã¸';
                        nextBtn.onclick = function() {
                            gameState.currentQuestionIndex++;
                            showQuestion();
                            showScreen('quiz-screen');
                        };
                    }
                }
                
                showScreen('feedback-screen');
            } catch (error) {
                console.error('Error in selectAnswer:', error);
            }
        }
        
        function nextQuestion() {
            try {
                gameState.currentQuestionIndex++;
                showQuestion();
                showScreen('quiz-screen');
            } catch (error) {
                console.error('Error in nextQuestion:', error);
            }
        }
        
        // ========== ãƒãƒƒã‚¸è¨ˆç®— ==========
        function calculateBadges() {
            try {
                gameState.accuracy = Math.round((gameState.score / 5) * 100);
                gameState.badges = [];
                
                badges.forEach(function(badge) {
                    try {
                        if (badge.condition()) {
                            gameState.badges.push(badge);
                        }
                    } catch (e) {
                        console.error('Error checking badge condition:', e);
                    }
                });
            } catch (error) {
                console.error('Error in calculateBadges:', error);
            }
        }
        
        // ========== çµæœè¡¨ç¤º ==========
        function showResultScreen() {
            try {
                var charInfo = characterInfo[gameState.character];
                if (charInfo) {
                    var resultImage = document.getElementById('result-char-image');
                    if (resultImage) {
                        resultImage.src = charInfo.image;
                        resultImage.alt = charInfo.name;
                    }
                    
                    var charName = document.getElementById('result-char-name');
                    if (charName) {
                        charName.textContent = charInfo.name;
                    }
                }
                
                var scoreDisplay = document.getElementById('score-display');
                if (scoreDisplay) {
                    scoreDisplay.textContent = gameState.score + '/5';
                }
                
                var accuracyDisplay = document.getElementById('accuracy');
                if (accuracyDisplay) {
                    accuracyDisplay.textContent = 'æ­£ç­”ç‡: ' + gameState.accuracy + '%';
                }
                
                var levelDisplay = document.getElementById('result-level');
                if (levelDisplay) {
                    levelDisplay.textContent = gameState.level;
                }
                
                var badgeHtml = '';
                if (gameState.badges.length > 0) {
                    badgeHtml = '<div class="badge-grid">';
                    gameState.badges.forEach(function(badge) {
                        badgeHtml += '<div class="badge-item"><div class="badge-icon">' + badge.icon + 
                                   '</div><div class="badge-name">' + badge.name + '</div></div>';
                    });
                    badgeHtml += '</div>';
                } else {
                    badgeHtml = '<p style="color: #999;">ãƒãƒƒã‚¸ãªã—</p>';
                }
                var badgeDisplay = document.getElementById('badge-display');
                if (badgeDisplay) {
                    badgeDisplay.innerHTML = badgeHtml;
                }
                
                showScreen('result-screen');
            } catch (error) {
                console.error('Error in showResultScreen:', error);
            }
        }
        
        function moveToConfirm() {
            try {
                document.getElementById('confirm-character').textContent = gameState.character;
                document.getElementById('confirm-level').textContent = gameState.level;
                document.getElementById('confirm-score').textContent = gameState.score + '/5';
                document.getElementById('confirm-accuracy').textContent = gameState.accuracy + '%';
                
                var badgeText = gameState.badges.length > 0 ? 
                    gameState.badges.map(function(b) { return b.name; }).join(', ') : 
                    'ãªã—';
                document.getElementById('confirm-badges').textContent = badgeText;
                
                showScreen('confirm-screen');
            } catch (error) {
                console.error('Error in moveToConfirm:', error);
            }
        }
        
        // ========== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€ä¿¡ ==========
        function finalSubmit() {
            try {
                var badgeText = gameState.badges.length > 0 ? 
                    gameState.badges.map(function(b) { return b.icon; }).join(' ') : 
                    'ãªã—';
                
                var params = '?character=' + encodeURIComponent(gameState.character) +
                             '&level=' + encodeURIComponent(gameState.level) +
                             '&score=' + encodeURIComponent(gameState.score + '/5') +
                             '&accuracy=' + encodeURIComponent(gameState.accuracy + '%') +
                             '&badges=' + encodeURIComponent(badgeText);
                
                fetch(gameState.scriptUrl + params, {
                    method: 'GET'
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    console.log('Success:', data);
                    saveToLocalStorage();
                    showSuccessScreen();
                })
                .catch(function(error) {
                    console.error('Fetch error:', error);
                    saveToLocalStorage();
                    showSuccessScreen();
                });
            } catch (error) {
                console.error('Error in finalSubmit:', error);
                alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }
        
        // ========== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ==========
        function saveToLocalStorage() {
            try {
                var stats = JSON.parse(localStorage.getItem('ychQuizStats') || '[]');
                stats.push({
                    date: new Date().toLocaleString('ja-JP'),
                    character: gameState.character,
                    level: gameState.level,
                    score: gameState.score,
                    accuracy: gameState.accuracy,
                    badges: gameState.badges.map(function(b) { return b.name; }).join(', ')
                });
                localStorage.setItem('ychQuizStats', JSON.stringify(stats));
            } catch (error) {
                console.error('Error in saveToLocalStorage:', error);
            }
        }
        
        function showSuccessScreen() {
            try {
                document.getElementById('success-character').textContent = 'âœ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ' + gameState.character;
                document.getElementById('success-level').textContent = 'âœ“ ãƒ¬ãƒ™ãƒ«: ' + gameState.level;
                document.getElementById('success-score').textContent = 'âœ“ æ­£è§£æ•°: ' + gameState.score + '/5';
                document.getElementById('success-accuracy').textContent = 'âœ“ æ­£ç­”ç‡: ' + gameState.accuracy + '%';
                
                showScreen('success-screen');
            } catch (error) {
                console.error('Error in showSuccessScreen:', error);
            }
        }
        
        // ========== æˆç¸¾è¡¨ç¤º ==========
        function loadStats() {
            try {
                var stats = JSON.parse(localStorage.getItem('ychQuizStats') || '[]');
                var html = '';
                
                if (stats.length === 0) {
                    html = '<p class="no-data">æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    var totalAttempts = stats.length;
                    var avgAccuracy = Math.round(stats.reduce(function(sum, s) { return sum + s.accuracy; }, 0) / stats.length);
                    var uniqueBadges = new Set();
                    stats.forEach(function(s) {
                        if (s.badges && s.badges !== 'ãªã—') {
                            s.badges.split(', ').forEach(function(b) { uniqueBadges.add(b); });
                        }
                    });
                    
                    html += '<div class="stat-item"><strong>ğŸ“Š çµ±è¨ˆæƒ…å ±</strong></div>' +
                            '<div class="stat-item">å®Ÿæ–½å›æ•°: <strong>' + totalAttempts + 'å›</strong></div>' +
                            '<div class="stat-item">å¹³å‡æ­£ç­”ç‡: <strong>' + avgAccuracy + '%</strong></div>' +
                            '<div class="stat-item">ç²å¾—ãƒãƒƒã‚¸æ•°: <strong>' + uniqueBadges.size + 'å€‹</strong></div>';
                    
                    if (stats.length > 1) {
                        html += '<div id="chart-container" class="chart-container"><canvas id="stats-chart"></canvas></div>';
                    }
                    
                    html += '<div class="stat-item" style="margin-top: 20px;"><strong>ğŸ“‹ è©³ç´°å±¥æ­´</strong></div>';
                    stats.reverse().forEach(function(stat, index) {
                        html += '<div class="stat-item">' +
                            '<strong>#' + (stats.length - index) + '</strong> | ' +
                            stat.date + '<br>' +
                            'ğŸ¯ ' + stat.character + ' | ' + stat.level + ' | ' +
                            stat.score + ' | ' + stat.accuracy + '%<br>' +
                            'ğŸ–ï¸ ' + (stat.badges || 'ãªã—') +
                            '</div>';
                    });
                    
                    html += '<button class="btn btn-danger" onclick="clearStats()" style="margin-top: 20px;">ğŸ—‘ï¸ æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆ</button>';
                }
                
                var statsContent = document.getElementById('stats-content');
                if (statsContent) {
                    statsContent.innerHTML = html;
                }
                
                if (stats.length > 1) {
                    setTimeout(function() {
                        drawChart(stats);
                    }, 100);
                }
            } catch (error) {
                console.error('Error in loadStats:', error);
            }
        }
        
        function drawChart(stats) {
            try {
                var ctx = document.getElementById('stats-chart');
                if (!ctx) return;
                
                var labels = stats.map(function(_, i) { return 'å›' + (i + 1); });
                var data = stats.map(function(s) { return s.accuracy; });
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ­£ç­”ç‡ã®æ¨ç§»',
                            data: data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error in drawChart:', error);
            }
        }
        
        function clearStats() {
            try {
                if (confirm('æˆç¸¾ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem('ychQuizStats');
                    loadStats();
                }
            } catch (error) {
                console.error('Error in clearStats:', error);
            }
        }
        
        // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
        function shuffleArray(array) {
            var result = array.slice();
            for (var i = result.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = result[i];
                result[i] = result[j];
                result[j] = temp;
            }
            return result;
        }
    </script>
</body>
</html>
